<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register Page</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
</head>

<body>
    <div class="container">
        <h2>Register</h2>
        <form id="registerForm" autocomplete="off">
            <div class="form-group">
                <label for="username">Username:</label>
                <input list="usernameSuggestions" type="text" id="username" name="username" required />
                <datalist id="usernameSuggestions"></datalist>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required />
            </div>
            <button type="submit">Register</button>
        </form>

        <p>Already have an account? <a href="/">Login here</a></p>
        <p id="message" style="color: red;"></p>
    </div>

    <script>
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const suggestionsList = document.getElementById("usernameSuggestions");
        const msg = document.getElementById("message");

        // ✅ Suggest usernames while typing (Gemini API call)
        usernameInput.addEventListener("input", async () => {
            const value = usernameInput.value.trim();
            suggestionsList.innerHTML = "";
            msg.textContent = "";

            if (value.length < 3) return;

            try {
                const res = await fetch(`/test-openai?name=${encodeURIComponent(value)}`);
                if (!res.ok) throw new Error("Gemini API error");

                const suggestions = await res.json();

                if (Array.isArray(suggestions)) {
                    suggestions.forEach(name => {
                        const option = document.createElement("option");
                        option.value = name;
                        suggestionsList.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("Username suggestion error:", err);
            }
        });

        // ✅ Submit registration form
        document.getElementById("registerForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            msg.textContent = "";
            suggestionsList.innerHTML = "";
            msg.style.color = "red";

            try {
                const res = await fetch("/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (!res.ok) {
                    msg.textContent = data.detail?.message || "Registration failed.";

                    // ✅ Show suggestions on duplicate username
                    const suggestions = data.detail?.suggestions || [];
                    suggestions.forEach(name => {
                        const option = document.createElement("option");
                        option.value = name;
                        suggestionsList.appendChild(option);
                    });
                    return;
                }

                // ✅ Success
                msg.style.color = "green";
                msg.textContent = data.message || "Registered successfully!";
                setTimeout(() => {
                    window.location.href = "/";
                }, 1500);

            } catch (error) {
                console.error("Registration error:", error);
                msg.textContent = "Server error. Please try again later.";
            }
        });
    </script>
</body>

</html>